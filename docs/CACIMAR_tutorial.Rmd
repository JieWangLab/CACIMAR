---
title: "CACIMAR tutorial"
author:  Jiang junyao
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
---

<style>
  body {
  font-family: "Helvetica";
    font-size: 18px;
    color: black;
  }
</style>

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```

# Installation

Follow the steps below to install CACIMAR package from GitHub and run it:

``` r
# install
# install.packages("devtools") # Install devtools if not already installed
devtools::install_github("jiang-junyao/CACIMAR")
# require
library(CACIMAR)
library(reshape2)
```

# 1.Identify markers
  In this part, CACIMAR first uses receiver operating characteristic (ROC) based method in 'FindAllMarkers' function of [Seurat](https://satijalab.org/seurat/articles/get_started.html) to identify markers in each cluster for every species individually. Then, based on marker genes identified above, CACIMAR calculates the power of markers(MP, MP= 2 × abs(AUC-0.5)) in each cluster and the expression differences of markers(logFC) between clusters. Markers with MP > 0.35 and logFC > 0.1 will be retained. 
  
## (1) Inputs data of this part

- ***Seurat object***
  Seurat object should have cell types information in 'active.ident' slot. Test data used here can be download from [Google drive](https://drive.google.com/drive/folders/15bqQmEH4cDFRiEHYZTEp4gYWK4FJAhBL?usp=sharing)

### (2) Identify markers

```r
### identify markers
Zf_seurat <- readRDS('Zf_seurat.rds')
Mm_seurat <- readRDS('Mm_seurat.rds')
Zf_marker <- Identify_Markers(Zf_seurat,PowerCutoff=0.35, DifferenceCutoff=0.1,PvalueCutoff=0.05)
Mm_marker <- Identify_Markers(Mm_seurat,PowerCutoff=0.35, DifferenceCutoff=0.1,PvalueCutoff=0.05)
### format markers table
Zf_marker <- Format_Markers_Frac(Zf_marker)
Mm_marker <- Format_Markers_Frac(Mm_marker)
```

# 2.Identify evolutionarily conserved cell types
   CACIMAR identifies evolutionarily conserved cell types and poorly conserved cell types using the conservation score of cell types (CSCT) and a phylogenetic tree. 
  
  CSCT is calculated based on the powers (or MP values) of shared markers in each pair of cell types, relative to the sum of the powers of all markers in each pair of cell types. Shared markers indicate the markers of one species that have homologs in the other species. If genes have multiple homologs, the gene with the highest power is selected. If the pair of cell types is mutually matched, and CSCT is greater than the third quartile of CSCT values, then this pair of cell types is considered a conserved cell type between two species. Mutually matched pair cell types mean that for every cell type in species 1, we look for the corresponding cell type in species 2 that has the highest CSCT value, and vice versa. The corresponding cell types in both species are said to be “mutually matched,” and they have the highest CSCT value relative to all other cell types in the other species.
  
  Besides, we generate a phylogenetic tree based on the CSCT value using the hierarchical clustering method UPGMA (unweighted pair group method using arithmetic mean) to further identify the conserved cell types and the poorly conserved cell types. If cell types from two species are from the same clade of bipartition, the two cell types are considered conserved cell types across species. However, if these conserved cell types are only identified by the phylogenetic tree of cell types, they are regarded as poorly conserved cell types.

## (1) Inputs data of this part

- ***Marker tables for two species***
  it Should contain three column: 'gene', 'cluster' and 'power'. Marker tables can be generated by 'Identify_Markers' function in part one above. Or, you can use following codes to load test data contained in CACIMAR.

```
load(system.file("extdata", "zf_mm_markers.rda", package = "CACIMAR"))
```

## (2) Homologous gene database
  Homologous gene database is needed. Here, CACIMAR has already generated Homologous gene database for human, mouse, zebrafish and chicken, you can directly use the following codes to load database:
  
```{r}
### load homologous gene database of human and mouse
OrthG <- OrthG_Hs_Mm
### load homologous gene database of human and chicken
OrthG <- OrthG_Hs_Ch
### load homologous gene database of human and zebrafish
OrthG <- OrthG_Hs_Zf
### load homologous gene database of mouse and chicken
OrthG <- OrthG_Mm_Ch
### load homologous gene database of mouse and zebrafish
OrthG <- OrthG_Mm_Zf
### load homologous gene database of zebrafish and chicken
OrthG <- OrthG_Zf_Ch
```

  In addition, you can use function in 'Build homologous gene database' part to generate your own homologous gene database if it does not provided here.

## (3) Identify evolutionarily conserved cell types

```r
### identify evolutionarily conserved cell types based on conservation score of cell types (CSCT)
OrthG <- OrthG_Mm_Zf
expression <- Identify_ConservedCellTypes(OrthG, Zf_marker, Mm_marker,'zf','mm')
SCT_matrix <- expression[[2]]
SNT_h <- SNT[grep('mm',rownames(SCT_matrix)),as.numeric(grep('zf',colnames(SCT_matrix)))]
### show the CSCT value with a heatmap
Heatmap_Cor(SNT_h,cluster_cols=F, cluster_rows=F,Color1 = c(rgb(102/255,46/255,115/255),rgb(31/255,153/255,139/255),rgb(251/255,232/255,48/255)))
```

![cross-species cell types](CACIMAR_tutorial_files/figure-html/conserved_celltypes_heatmap.png)

## (4) Further evaluate evolutionarily conserved cell types and poorly conserved cell types through phylogenetic tree
  By default, dark blue shows the evolutionarily conserved cell types, light blue shows the poorly conserved cell types, and grey shows the unconserved cell types. You can use tiplab_cols to set the targeted colors you want. Besides, tree_method can be set to "classic Neighbor-Joining" if you want to change the method used to construct the phylogenetic tree.

```r
### get the conserved cell types based on the mutually matched and bigger than 3/4 CSCT score
conserved_hm_celltypes <- get_conserved_hm_celltypes(SNT_h)
### generate a phylogenetic tree
p <- Plot_phylogenetic_tree(SCT_matrix = SCT_matrix,
                       tree_method = "hierarchical clustering", 
                       species.vector = species.vector,
                       conserved_hm_celltype = conserved_hm_celltypes,
                       colors_labels = c("Mouse", "Zebrafish")) 
```

![cross-species cell types](CACIMAR_tutorial_files/figure-html/UPGMA_Tree.fontcolors2.png)

```r
### show the conservation of cell types in data frame
head(p$conserved_table)
```


# 3.Identify evolutionarily conserved markers
  CACIMAR first utilizes **homologous genes database** to refine markers found by "FindAllMarkers" function using ROC. And markers that exist in homologous database will be retained as shared markers. Then, CACIMAR selects markers that are in the same cell type between two species as evolution-conserved markers.

## (1) Inputs data of this part
- ***Marker tables for two species***
  First column should be gene name, second column should be cluster corresponding to marker gene. Marker tables can be generated by 'Identify_Markers' function in part one above. Or, you can use following codes to load test data.

```r
load(system.file("extdata", "zf_mm_markers.rda", package = "CACIMAR"))
```

## (2) Homologous gene database
```r
OrthG <- OrthG_Mm_Zf
```

## (3) Find evolutionarily conserved markers 
```{r message=FALSE, eval=FALSE}
ConservedMarker <- Identify_ConservedMarkers(OrthG, Mm_marker, Zf_marker,
                                               Species_name1 = 'mm', Species_name2 = 'zf')
```

### Plot conserved markers
```r
###Adjust the format to make figures of conserved markers
MarkersPlot <- FormatConservedMarkers(ConservedMarker)
###plot conserved markers for mouse
Plot_MarkersHeatmap(MarkersPlot[[1]],cellheight = 1.5,cellwidth = 6,legend = T)
```
![Mm conserved markers](CACIMAR_tutorial_files/figure-html/mm_conserved_marker2.png)
```r
###plot conserved markers for zebrafish
Plot_MarkersHeatmap(MarkersPlot[[2]],cellheight = 1.5,cellwidth = 6,legend = T)
```
![Zf conserved markers](CACIMAR_tutorial_files/figure-html/zf_conserved_marker2.png)

### Plot species-specific markers
```{r, eval=FALSE}
### Idnetiy Mm specific markers
Mm_specific_markers <- Mm_marker[!Mm_marker$gene %in% ConservedMarker$mmgene
                            ,c(-1,-3,-4,-5)]
Plot_MarkersHeatmap(Mm_specific_markers,cellheight = 0.2,cellwidth = 6)
### Identify Zf specific markers
Zf_specific_markers <- Zf_marker[!Zf_marker$gene %in% ConservedMarker$zfgene
                            ,c(-1,-3,-4,-5)]
Plot_MarkersHeatmap(Zf_specific_markers,cellheight = 0.5,cellwidth = 6)
```


# 4. Identify conserved intracellular regulation
  We utilized CACIMAR to examine the evolutionary conservation of two distinct regulatory networks: cell type-specific regulatory networks and regulatory subnetworks, also known as modules, across different species. CACIMAR calculates the conservation score of regulatory networks (CSRN) among cell types/modules in regulatory networks of different species. SCN is calculated based on two criteria: (I) fraction of homologous genes (nodes) and all genes; (II) fraction of interactions (edges) among homologous genes and all interactions. A higher CSRN indicates a more conserved regulatory network. 

## (1) Inputs data of this part
- ***Cell type specific network or Modularized regulatory networks for two species***
  Each network should contain 4 columns: 'Source', 'SourceGroup', 'Target', 'TargetGroup'. Modularized regulatory networks can be generated by [IReNA](https://github.com/jiang-junyao/IReNA) or [WGCNA](https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/). Or, you can use following codes to load test data in this part.

```r
load(system.file("extdata", "gene_network.rda", package = "CACIMAR"))
```
- ***Homologous gene database***
```{r}
OrthG <- OrthG_Mm_Zf
```

## (2) Cell type specific regulatory networks analysis
  The following cell type specific regulatory networks are constructed by [IReNA](https://github.com/jiang-junyao/IReNA), which can integrate scRNA-seq and scATAC-seq/ATAC-seq data or use scRNA-seq/RNA-seq data alone to construct modularized regulatory networks. 

```{r warning=FALSE,message=FALSE, eval=FALSE}
ConservedNetworks_ct <- identify_ct_ConservedNetworks(OrthG, Species1_GRN, Species2_GRN, 'mm', 'zf')
Heatmap_Cor(ConservedNetworks_ct[[2]], cluster_cols=F, cluster_rows=F, Color1 = c(rgb(102/255,46/255,115/255), rgb(31/255,153/255,139/255), rgb(251/255,232/255,48/255)))
```

## (3) Modularized regulatory networks analysis
  Modular regulatory networks used here are constructed by R package [IReNA](https://github.com/jiang-junyao/IReNA), which can integrate scRNA-seq and scATAC-seq/ATAC-seq data or use scRNA-seq/RNA-seq data alone to construct modularized regulatory networks. [WGCNA](https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/) is an optional method that can generate the input. However, WGCNA only can construct regulatory networks through bulk RNA-seq data.

```{r warning=FALSE,message=FALSE, eval=FALSE}
ConservedNetworks <- Identify_ConservedNetworks(OrthG, mm_gene_network, zf_gene_network, 'mm', 'zf')
Heatmap_Cor(ConservedNetworks[[2]], cluster_cols=F, cluster_rows=F, Color1 = c(rgb(102/255,46/255,115/255), rgb(31/255,153/255,139/255), rgb(251/255,232/255,48/255)))
```


# 5.Identify conserved intercellular interactions (cell-cell interaction)
  CACIMAR identifies evolutionarily conserved cell-cell interactions (CCI) based on the level of ligands and receptors using the SingleCellSignalR algorithm from [liana](https://saezlab.github.io/liana/). CCI that fulfill the following criteria will be considered as evolutionarily conserved: (I) the interactions between ligands and receptors are consistent; (II) the cell type of the ligand and receptor in species 1 should match the cell type of the ligand and receptor in species 2, respectively.

## (1) Inputs data of this part
- ***seurat object***
```{r}
# load(system.file("extdata", "cci_test.rda", package = "CACIMAR"))
```

- ***Homologous gene database***
```{r}
OrthG <- OrthG_Mm_Zf
```

## (2) cell-cell interaction analysis with SingleCellSignalR algorithm through liana
```{r, eval=FALSE}
# Mouse analysis
SingleCellSignalR_mouse_result <- perform_CCI_analysis(seurat_obj=Mm_seurat, target_organism=10090)
# Zebrafish analysis
SingleCellSignalR_zebrafish_result <- perform_CCI_analysis(seurat_obj=Zf_seurat, target_organism=7955)
```

## (3) identified the evolutionarily conserved cell-cell interactions (CCI)


## Example
Example dataset (mm_ccc.rds & zf_ccc.rds) can be download from [onedrive](https://westlakeu-my.sharepoint.com/:f:/g/personal/jiangjunyao_westlake_edu_cn/ElAKLi2XcIVHp8QV97hMRyQBI2mu_MQcb9zDGfd6TML_QQ?e=bfmhtC)
```r
### load test data
mm_ccc <- readRDS('mm_ccc.rds')
zf_ccc <- readRDS('zf_ccc.rds')
### extract signalings dataframe
mm.net <- subsetCommunication(mm_ccc)
zf.net <- subsetCommunication(zf_ccc)
mm.input <- mm.net[,c(3,4,1,2)]
zf.input <- zf.net[,c(3,4,1,2)]
### identify conserved CCC
ConservedCCI <- Identify_ConservedCCI(OrthG,mm.input,zf.input,
                      Species_name1='mm',Species_name2='zf')
### add interactions probability from cellchat
mm.ccc.score = add_cellchat_prob(ConservedCCI[[1]],mm.net)
zf.ccc.score = add_cellchat_prob(ConservedCCI[[2]],zf.net)
print(mm.ccc.score)
```
```{r echo=FALSE, eval=FALSE}
### load test data
mm.ccc.score <- read.delim("F:/platform/cci/mm_conserved_ccc_score.txt")
zf.ccc.score <- read.delim("F:/platform/cci/zf_conserved_ccc_score.txt")
df=read.delim('F:\\platform\\cci/mm_conserved_ccc_score.txt')
print(df)
```
Then, we visualize the result
```{r warning=FALSE, eval=FALSE}
### visualize mm conserved ccc
mm.ccc.plot=dcast(mm.ccc.score[,3:5],sp1source~sp1target,sum,value.var = 'prob')
rownames(mm.ccc.plot)=mm.ccc.plot[,1]
mm.ccc.plot=mm.ccc.plot[,2:ncol(mm.ccc.plot)]
Heatmap_Cor(mm.ccc.plot,cluster_cols=F, cluster_rows=F,Color1 = c(rgb(102/255,46/255,115/255),rgb(31/255,153/255,139/255),rgb(251/255,232/255,48/255)))
### visualize zf conserved ccc
zf.ccc.plot=dcast(zf.ccc.score[,3:5],sp2source~sp2target,sum,value.var = 'prob')
rownames(zf.ccc.plot)=zf.ccc.plot[,1]
zf.ccc.plot=zf.ccc.plot[,2:ncol(zf.ccc.plot)]
Heatmap_Cor(zf.ccc.plot,cluster_cols=F, cluster_rows=F,Color1 = c(rgb(102/255,46/255,115/255),rgb(31/255,153/255,139/255),rgb(251/255,232/255,48/255)))
```



# Build homologous gene database
  Under the situation that homologous gene database of your interested species is not included in our package, CACIMAR provides to build your own homologous gene database according to MGI database. 

*Hint* Only github version of CACIMAR supports this part

## (1) Inputs data of this part

- ***MGI database***
  MGI database can be downloaded from http://www.informatics.jax.org/downloads/reports/HOM_AllOrganism.rpt.

- ***species name***
  Currently CACIMAR is able to build homologous gene database for the following species:
  
```
1) 'mm' for mouse; 
2) 'zf' for zebrafish; 
3) 'hs' for human; 
4) 'ch' for chicken; 
5) 'cf' for dog; 
6) 'pt' for chimpanzee; 
7) 'xt' for frog; 
8) 'rn' for rat; 
9) 'bt' for cattle; 
10) 'rh' for macaque
```

## (2) Example for build homologous gene database
```r
### download data
download.file(destfile = 'D:\\GIBH\\platform\\OrthG database/HOM.txt',url = 'http://www.informatics.jax.org/downloads/reports/HOM_AllOrganism.rpt')
### load data
HOM=read.delim('D:\\GIBH\\platform\\OrthG database/HOM.txt')
### build homologous gene database for dog and mouse
Species_name1 <- 'cf'
Species_name2 <- 'mm'
OrthG_Cf_Mm <- buildHomDatabase(HOM, Species_name1, Species_name2)
```






